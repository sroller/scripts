#!/usr/bin/env ruby

require 'csv'
require 'fileutils'

CSV_DATA = File.dirname(__FILE__)+'/../data/weatherlog.csv'
FONT = "Envy-Code-R"

source_dir = ARGV[0] || "."
target_dir = (ARGV[1] || "." ) + "/exif-#{Process.pid}"
FileUtils.mkdir_p target_dir

wetter = CSV.read(CSV_DATA, { col_sep: ';', converters: :all, headers: true })

jpgs = Dir["#{source_dir}/**/tl*.jpg"].sort
puts "found #{jpgs.size}"

# jpgs.first(5) do |jpg|
jpgs.each_with_index do |jpg,index|
  s = `identify -format "%[EXIF:DateTimeOriginal]" #{jpg}`
  timestamp = DateTime.strptime(s, '%Y:%m:%d %H:%M:%S')
  # puts timestamp.strftime("%Y-%m-%d %H:%M")
  (moment, temperature, wind) = wetter.find {|w| timestamp < w['time']}
  # puts "#{timestamp.strftime("%Y-%m-%d %H:%M")}, #{moment}, #{temperature}, #{wind}"
  puts "convert #{jpg} -font \"#{FONT}\" -gravity NorthEast -pointsize 24 -fill White -annotate +12+12 \"#{timestamp.strftime("%Y-%m-%d %H:%M")}\" -annotate +12+36 \"temp: #{"%.1f" % temperature[1]}c wind: #{"%.1f" % wind[1]} km/h\" #{target_dir}/tl#{'%06d' % index}.jpg"
  `convert #{jpg} -font \"#{FONT}\" -gravity NorthEast -pointsize 24 -fill White -annotate +12+12 \"#{timestamp.strftime("%Y-%m-%d %H:%M")}\" -annotate +12+36 \"temp: #{"%.1fc" % temperature[1]} wind: #{"%.1f km/h" % wind[1]}\" #{target_dir}/tl#{'%06d' % index}.jpg`
end
