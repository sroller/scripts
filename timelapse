#!/bin/bash

# starts a timelapse process in the background

# first parameter has to be start or stop
# the following parameter will be appended to the raspistill command

function help {
  SCRIPT=${0##*/}
  echo
  if [ ! -z "$PID" ]; then
    echo "     raspistill is running"
    echo "     PID: $PID"
    echo "     output to $(cat ~/tmp/timelapse.dir)"
    echo
    echo "     type '$SCRIPT stop' to end timelapse recording"
  else
    echo "     raspistill is not running"
    echo
    echo "     type '$SCRIPT start' to begin timelapse"
  fi
  exit
}

# default parameter
EX=auto
TL=30000
WIDTH=1280
HEIGHT=720
FLIP=

while getopts ":nut:w:h:" opt; do
  case $opt in
    n)
      echo "night start"
      EX="night"
      ;;
    t)
      echo "interval $OPTARG"
      TL=$OPTARG
      ;;
    w)
      echo "width $OPTARG"
      WIDTH=$OPTARG
      ;;
    h)
      echo "height $OPTARG"
      HEIGHT=$OPTARG
      ;;
    v)
      echo "upside down mode"
      FLIP=-vf -hf
      ;;
    \?)
      echo "invalid option: -$OPTARG"
      ;;
  esac
done
shift $((OPTIND-1))

CMD=$1
shift

# echo raspistill -w $WIDTH -h $HEIGHT -ex $EX -tl $TL $CMD


PID=$(pgrep raspistill)
if [ "$CMD" = "start" ] || [ "$CMD" = "stop" ]
then

  case "$CMD" in
    stop)

      if [ -z "$PID" ]
      then
        echo raspistill is not running
      else
        kill $PID
        echo we stopped raspistill with pid: $PID
        echo
        echo "go to $(cat ~/tmp/timelapse.dir) for the output"
      fi
      ;;

    start)
      if [ ! -z "$PID" ]
      then
        echo "found running raspistill, pid $PID"
      else
        DIR=~/timelapse/`date +%Y%m%d-%H%M`
        mkdir -p ~/tmp
        echo $DIR > ~/tmp/timelapse.dir
        FOTOS=~/pictures
        mkdir -p $DIR
        echo raspistill -w $WIDTH -h $HEIGHT -tl $TL $FLIP --thumb none -ex $EX -n -t 0 -l $FOTOS/last.jpg -o $DIR/tl%06d.jpg $* &
        raspistill -w $WIDTH -h $HEIGHT -tl $TL $FLIP --thumb none -ex $EX -n -t 0 -l $FOTOS/last.jpg -o $DIR/tl%06d.jpg $* &
        echo raspistill started
        echo stop with: timelapse stop
        echo output directory: $DIR
      fi
      ;;

    *)
      SCRIPTNAME=${0##*/}
      echo "$SCRIPTNAME start|stop"

      ;;
  esac

else
  help
fi

