#!/bin/bash

# starts a timelapse process in the background

# first parameter has to be start or stop
# the following parameter will be appended to the raspistill command

function help {
  SCRIPT=$(basename $0)
  echo "$SCRIPT start|stop"
  echo first parameter has to be 'start' or 'stop'
  echo the following parameters will be handed to raspistill
  echo try again ...
  exit
}

CMD=$1
shift
PID=$(pgrep raspistill)
if [ "$CMD" = "start" ] || [ "$CMD" = "stop" ]
then

  case "$CMD" in
    stop)

      if [ -z "$PID" ]
      then
        echo ...
      else
        kill $PID
        echo we stopped raspistill with pid: $PID
      fi
      ;;

    start)
      if [ ! -z "$PID" ]
      then
        echo "found running raspistill, pid $PID"
      else
        DIR=~/timelapse/`date +%Y%m%d-%H%M`
        FOTOS=~/pictures
        mkdir -p $DIR
        ln -nsf $DIR ~/timelapse/last
        raspistill -w 1280 -h 720 -tl 29000 --thumb none -n -t 0 -l $FOTOS/last.jpg -o $DIR/tl%06d.jpg $* &
        # raspistill -w 2592 -h 1096 --thumb none -tl 5000 -n -t 0 -l $FOTOS/last.jpg -o $DIR/tl%06d.jpg $* &
        echo raspistill started
        echo stop with: timelapse stop
      fi
      ;;

    *)
      SCRIPTNAME=$(basename $0)
      echo "$SCRIPTNAME start|stop"

      ;;
  esac

else
  if [ -z "$PID" ]
  then
    echo raspistill not running
  else
    echo raspistill found with pid $PID
  fi
  help
fi

